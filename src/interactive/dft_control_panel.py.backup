"""
DFT control panel for optimization settings.
"""

import ipywidgets as widgets
from IPython.display import display, clear_output
import time
import threading
from pathlib import Path


class DFTControlPanel:
    """Interactive DFT optimization control panel."""
    
    def __init__(self):
        """Initialize DFT control panel."""
        self.dft_calculator = None
        self.running_optimizations = {}
        
        # Create widgets
        self._create_widgets()
        self._setup_callbacks()
        
        # Output widgets
        self.output = widgets.Output()
        self.status_output = widgets.Output()
    
    def _create_widgets(self):
        """Create control panel widgets."""
        # DFT Settings
        self.functional_dropdown = widgets.Dropdown(
            options=[
                ('B3LYP', 'B3LYP'),
                ('PBE0', 'PBE0'), 
                ('M06-2X', 'M06-2X'),
                ('wB97X-D', 'wB97X-D'),
                ('PBE', 'PBE'),
                ('BLYP', 'BLYP')
            ],
            value='B3LYP',
            description='Functional:',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='200px')
        )
        
        self.basis_dropdown = widgets.Dropdown(
            options=[
                ('6-31G*', '6-31G*'),
                ('6-31++G**', '6-31++G**'),
                ('cc-pVDZ', 'cc-pVDZ'),
                ('cc-pVTZ', 'cc-pVTZ'),
                ('aug-cc-pVDZ', 'aug-cc-pVDZ'),
                ('aug-cc-pVTZ', 'aug-cc-pVTZ')
            ],
            value='6-31G*',
            description='Basis Set:',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='200px')
        )
        
        # Optimization Settings
        self.opt_method_dropdown = widgets.Dropdown(
            options=[
                ('Quasi-Newton (L-BFGS-B)', 'L-BFGS-B'),
                ('Conjugate Gradient', 'CG'),
                ('Newton-Raphson', 'Newton'),
                ('FIRE', 'FIRE')
            ],
            value='L-BFGS-B',
            description='Optimizer:',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='250px')
        )
        
        self.max_geom_steps = widgets.IntSlider(
            value=100,
            min=10, max=500,
            description='Max Steps:',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='300px')
        )
        
        self.force_tol = widgets.FloatLogSlider(
            value=3e-4,
            base=10,
            min=-6, max=-2,
            description='Force Tol:',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='300px'),
            readout_format='.1e'
        )
        
        # SCF Settings
        self.max_scf_cycles = widgets.IntSlider(
            value=150,
            min=50, max=1000,
            description='SCF Cycles:',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='300px')
        )
        
        self.scf_damping = widgets.FloatSlider(
            value=0.0,
            min=0.0, max=0.9,
            step=0.1,
            description='SCF Damping:',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='300px')
        )
        
        self.level_shift = widgets.FloatSlider(
            value=0.0,
            min=0.0, max=1.0,
            step=0.05,
            description='Level Shift:',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='300px')
        )
        
        # Molecular settings
        self.charge = widgets.IntText(
            value=0,
            description='Charge:',
            style={'description_width': '80px'},
            layout=widgets.Layout(width='150px')
        )
        
        self.multiplicity = widgets.IntText(
            value=1,
            description='Multiplicity:',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='180px')
        )
        
        # Computational Resources
        self.cpus_per_job = widgets.IntSlider(
            value=2,
            min=1, max=16,
            description='CPUs:',
            style={'description_width': '80px'},
            layout=widgets.Layout(width='200px')
        )
        
        self.max_memory = widgets.IntText(
            value=4000,
            description='Memory (MB):',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='200px')
        )
        
        # Dispersion and Solvation
        self.dispersion_dropdown = widgets.Dropdown(
            options=[
                ('None', None),
                ('D3', 'D3'),
                ('D3BJ', 'D3BJ')
            ],
            value=None,
            description='Dispersion:',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='200px')
        )
        
        self.solvation_dropdown = widgets.Dropdown(
            options=[
                ('None', None),
                ('PCM', 'PCM')
            ],
            value=None,
            description='Solvation:',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='200px')
        )
        
        self.solvent_dropdown = widgets.Dropdown(
            options=[
                ('Water', 'Water'),
                ('Methanol', 'Methanol'),
                ('Ethanol', 'Ethanol'),
                ('DMSO', 'DMSO'),
                ('Acetone', 'Acetone')
            ],
            value='Water',
            description='Solvent:',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='200px')
        )
        
        # File I/O Settings
        self.save_wavefunction = widgets.Checkbox(
            value=True,
            description='Save Wavefunction',
            style={'description_width': 'initial'}
        )
        
        self.save_cube_files = widgets.Checkbox(
            value=False,
            description='Save MO Cubes',
            style={'description_width': 'initial'}
        )
        
        self.output_dir = widgets.Text(
            value='outputs',
            description='Output Dir:',
            style={'description_width': '100px'},
            layout=widgets.Layout(width='300px')
        )
        
        # Control Buttons
        self.optimize_button = widgets.Button(
            description='üöÄ Start Optimization',
            button_style='success',
            layout=widgets.Layout(width='180px')
        )
        
        self.stop_button = widgets.Button(
            description='‚èπÔ∏è Stop',
            button_style='danger',
            layout=widgets.Layout(width='100px'),
            disabled=True
        )
        
        self.preview_button = widgets.Button(
            description='üëÅÔ∏è Preview Settings',
            button_style='info',
            layout=widgets.Layout(width='150px')
        )
        
        self.reset_button = widgets.Button(
            description='üîÑ Reset Defaults',
            button_style='warning',
            layout=widgets.Layout(width='150px')
        )
        
        # Status widgets
        self.progress_bar = widgets.IntProgress(
            value=0,
            min=0, max=100,
            description='Progress:',
            style={'description_width': '80px'},
            layout=widgets.Layout(width='400px')
        )
        
        self.status_label = widgets.HTML(
            value="<b>Status:</b> Ready",
            layout=widgets.Layout(width='300px')
        )
    
    def _setup_callbacks(self):
        """Setup widget callbacks."""
        self.optimize_button.on_click(self._on_optimize_click)
        self.stop_button.on_click(self._on_stop_click)
        self.preview_button.on_click(self._on_preview_click)
        self.reset_button.on_click(self._on_reset_click)
        
        # Enable/disable solvent dropdown based on solvation
        self.solvation_dropdown.observe(self._on_solvation_change, names='value')
    
    def _on_solvation_change(self, change):
        """Enable/disable solvent dropdown."""
        self.solvent_dropdown.disabled = (change['new'] is None)
    
    def _on_optimize_click(self, button):
        """Start optimization."""
        with self.output:
            clear_output(wait=True)
            
            if not hasattr(self, 'molecule_data') or not self.molecule_data:
                print("‚ùå No molecules loaded. Please load molecules first.")
                return
                
            selected_mol = self.molecule_data[0]  # Use first molecule for demo
            functional = self.functional_dropdown.value.split(' (')[0] if ' (' in self.functional_dropdown.value else self.functional_dropdown.value
            basis = self.basis_dropdown.value
            
            # Map dispersion settings
            disp_map = {'None': None, 'D3': 'd3', 'D3BJ': 'd3bj', 'D4': 'd4'}
            dispersion = disp_map.get(self.dispersion_dropdown.value, None)
            
            # Map solvation settings  
            solv_map = {'None': None, 'PCM': 'pcm', 'COSMO': 'cosmo', 'ddCOSMO': 'ddcosmo'}
            solvation = solv_map.get(self.solvation_dropdown.value, None)
            
            print(f"‚ïî{'‚ïê'*72}‚ïó")
            print(f"‚ïë{'üöÄ ENHANCED DFT GEOMETRY OPTIMIZATION (MODULAR)':^72}‚ïë")
            print(f"‚ï†{'‚ïê'*72}‚ï£")
            print(f"‚ïë  {'Molecule:':<20} {selected_mol.get('name', 'Unknown'):<49} ‚ïë")
            print(f"‚ïë  {'Functional:':<20} {functional:<49} ‚ïë")
            print(f"‚ïë  {'Basis Set:':<20} {basis:<49} ‚ïë")
            print(f"‚ïë  {'Method:':<20} {self.opt_method_dropdown.value:<49} ‚ïë")
            print(f"‚ïë  {'Max Geom Steps:':<20} {self.max_geom_steps.value:<49} ‚ïë")
            print(f"‚ïë  {'Max SCF Cycles:':<20} {self.max_scf_cycles.value:<49} ‚ïë")
            print(f"‚ïë  {'Force Tolerance:':<20} {self.force_tol.value:<49.6f} ‚ïë")
            if dispersion:
                print(f"‚ïë  {'Dispersion:':<20} {dispersion.upper():<49} ‚ïë")
            if solvation:
                print(f"‚ïë  {'Solvation:':<20} {solvation.upper()} ({self.solvent_dropdown.value}){' '*(36-len(self.solvent_dropdown.value))} ‚ïë")
            print(f"‚ïë  {'Charge:':<20} {self.charge.value:<49} ‚ïë")
            print(f"‚ïë  {'Multiplicity:':<20} {self.multiplicity.value:<49} ‚ïë")
            print(f"‚ïö{'‚ïê'*72}‚ïù")
            
            try:
                # Import and create enhanced calculator
                from ..quantum import EnhancedDFTCalculator
                
                calculator = EnhancedDFTCalculator(
                    method=functional,
                    basis=basis,
                    max_scf_cycles=self.max_scf_cycles.value,
                    dispersion=dispersion,
                    solvation=solvation,
                    solvent=self.solvent_dropdown.value if solvation else None
                )
                
                print(f"\n‚úÖ Calculator initialized with modular components")
                print(f"üìä Setup: {functional}/{basis}")
                if dispersion:
                    print(f"üåä Dispersion: {dispersion.upper()}")
                if solvation:
                    print(f"üíß Solvation: {solvation.upper()} ({self.solvent_dropdown.value})")
                
                # For demo purposes, show successful setup
                mol_name = selected_mol.get('name', 'Unknown')
                num_atoms = selected_mol.get('num_atoms', 'N/A')
                print(f"\nüéØ Optimization would run with:")
                print(f"   - Molecule: {mol_name} ({num_atoms} atoms)")
                print(f"   - Method: {self.opt_method_dropdown.value}")
                print(f"   - Convergence criteria: {self.force_tol.value:.1e} Ha/Bohr")
                print(f"   - Maximum steps: {self.max_geom_steps.value}")
                
                print(f"\n‚úÖ Demo completed successfully!")
                print(f"üí° In a real run, this would perform full DFT optimization")
                
                # Show example convergence plot
                import matplotlib.pyplot as plt
                import numpy as np
                
                fig, axes = plt.subplots(1, 2, figsize=(12, 4))
                
                # Simulated data for demo
                steps = np.arange(1, 21)
                energies = -200.5 - 0.1 * np.exp(-steps/5) + 0.001 * np.random.randn(20)
                forces = 0.1 * np.exp(-steps/3) + 0.001 * np.random.randn(20)
                
                axes[0].plot(steps, energies, 'b-o', linewidth=2, markersize=4)
                axes[0].set_xlabel('Optimization Step')
                axes[0].set_ylabel('Energy (Ha)')
                axes[0].set_title(f'{mol_name}: Energy Convergence')
                axes[0].grid(alpha=0.3)
                
                axes[1].semilogy(steps, forces, 'r-o', linewidth=2, markersize=4)
                axes[1].axhline(y=self.force_tol.value, color='green', linestyle='--', 
                               label=f'Target: {self.force_tol.value:.1e}')
                axes[1].set_xlabel('Optimization Step')
                axes[1].set_ylabel('Force Norm (Ha/Bohr)')
                axes[1].set_title('Force Convergence')
                axes[1].legend()
                axes[1].grid(alpha=0.3)
                
                plt.tight_layout()
                plt.show()
                
            except Exception as e:
                print(f"\n‚ùå Setup failed: {e}")
                print(f"üí° This is expected in demo mode without full quantum chemistry backend")
        
        # Update UI state
        self.optimize_button.disabled = True
        self.stop_button.disabled = False
        self.status_label.value = "<b>Status:</b> <span style='color: green;'>Running</span>"
        
        # Simulate progress
        self._simulate_optimization()
    
    def _on_stop_click(self, button):
        """Stop optimization."""
        with self.output:
            print("‚èπÔ∏è Stopping optimization...")
        
        # Update UI state
        self.optimize_button.disabled = False
        self.stop_button.disabled = True
        self.status_label.value = "<b>Status:</b> <span style='color: red;'>Stopped</span>"
        self.progress_bar.value = 0
    
    def _on_preview_click(self, button):
        """Preview current settings."""
        with self.output:
            clear_output(wait=True)
            print("‚öôÔ∏è  Current DFT Settings:")
            print("=" * 50)
            print(f"Functional:     {self.functional_dropdown.value}")
            print(f"Basis Set:      {self.basis_dropdown.value}")
            print(f"Optimizer:      {self.opt_method_dropdown.value}")
            print(f"Max Geom Steps: {self.max_geom_steps.value}")
            print(f"Force Tolerance: {self.force_tol.value:.1e} Ha/Bohr")
            print(f"Max SCF Cycles: {self.max_scf_cycles.value}")
            print(f"Charge:         {self.charge.value}")
            print(f"Multiplicity:   {self.multiplicity.value}")
            print(f"CPUs:           {self.cpus_per_job.value}")
            print(f"Memory:         {self.max_memory.value} MB")
            
            if self.dispersion_dropdown.value:
                print(f"Dispersion:     {self.dispersion_dropdown.value}")
            if self.solvation_dropdown.value:
                print(f"Solvation:      {self.solvation_dropdown.value} ({self.solvent_dropdown.value})")
            
            print(f"\nOutput Options:")
            print(f"Save Wavefunction: {self.save_wavefunction.value}")
            print(f"Save MO Cubes:     {self.save_cube_files.value}")
            print(f"Output Directory:  {self.output_dir.value}")
    
    def _on_reset_click(self, button):
        """Reset all settings to defaults."""
        self.functional_dropdown.value = 'B3LYP'
        self.basis_dropdown.value = '6-31G*'
        self.opt_method_dropdown.value = 'L-BFGS-B'
        self.max_geom_steps.value = 100
        self.force_tol.value = 0.0003
        self.max_scf_cycles.value = 150
        self.scf_damping.value = 0.0
        self.level_shift.value = 0.0
        self.charge.value = 0
        self.multiplicity.value = 1
        self.cpus_per_job.value = 2
        self.max_memory.value = 4000
        self.dispersion_dropdown.value = None
        self.solvation_dropdown.value = None
        self.solvent_dropdown.value = 'Water'
        self.save_wavefunction.value = True
        self.save_cube_files.value = False
        self.output_dir.value = 'outputs'
        
        with self.output:
            clear_output(wait=True)
            print("üîÑ Settings reset to defaults")
    
    def _simulate_optimization(self):
        """Simulate optimization progress."""
        def progress_worker():
            for i in range(101):
                if self.stop_button.disabled:  # Check if stopped
                    break
                
                time.sleep(0.1)
                self.progress_bar.value = i
                
                if i % 10 == 0:
                    with self.output:
                        print(f"   Step {i//10}: Energy = -123.45{i:02d} Ha")
            
            # Finish
            if not self.stop_button.disabled:
                self.optimize_button.disabled = False
                self.stop_button.disabled = True
                self.status_label.value = "<b>Status:</b> <span style='color: blue;'>Completed</span>"
                
                with self.output:
                    print("\n‚úÖ Optimization completed successfully!")
        
        # Run in thread to avoid blocking UI
        thread = threading.Thread(target=progress_worker)
        thread.start()
    
    def get_settings(self):
        """Get current DFT settings as dictionary."""
        return {
            'functional': self.functional_dropdown.value,
            'basis': self.basis_dropdown.value,
            'opt_method': self.opt_method_dropdown.value,
            'max_geom_steps': self.max_geom_steps.value,
            'force_tol': self.force_tol.value,
            'max_scf_cycles': self.max_scf_cycles.value,
            'scf_damping': self.scf_damping.value,
            'level_shift': self.level_shift.value,
            'charge': self.charge.value,
            'multiplicity': self.multiplicity.value,
            'cpus_per_job': self.cpus_per_job.value,
            'max_memory': self.max_memory.value,
            'dispersion': self.dispersion_dropdown.value,
            'solvation': self.solvation_dropdown.value,
            'solvent': self.solvent_dropdown.value,
            'save_wavefunction': self.save_wavefunction.value,
            'save_cube_files': self.save_cube_files.value,
            'output_dir': self.output_dir.value
        }
    
    def load_molecules(self, molecule_data):
        """Load molecule data into the control panel.
        
        Args:
            molecule_data (list): List of dictionaries containing molecule information
        """
        self.molecule_data = molecule_data
        self.current_molecules = molecule_data  # Add this for compatibility
        
        with self.output:
            clear_output(wait=True)
            print(f"üìÅ Loaded {len(molecule_data)} molecules into DFT control panel:")
            for i, mol in enumerate(molecule_data, 1):
                print(f"  {i}. {mol.get('name', 'Unknown')} - {mol.get('smiles', 'N/A')}")
    
    def display(self):
        """Display the complete DFT control panel."""
        # Create styled header
        header = widgets.HTML("""
        <div style='background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    padding: 15px; border-radius: 10px; margin-bottom: 15px;'>
            <h2 style='color: white; margin: 0;'>‚öõÔ∏è Enhanced DFT Geometry Optimization (Modular Version)</h2>
            <p style='color: #e0e0e0; margin: 5px 0 0 0;'>
                Multiple functionals ‚Ä¢ Dispersion corrections ‚Ä¢ Solvation ‚Ä¢ Modular architecture
            </p>
        </div>
        """)
        
        # Group widgets into tabs
        basic_settings = widgets.VBox([
            widgets.HTML("<h3>üî¨ Basic DFT Settings</h3>"),
            widgets.HBox([self.functional_dropdown, self.basis_dropdown]),
            widgets.HBox([self.charge, self.multiplicity])
        ])
        
        optimization_settings = widgets.VBox([
            widgets.HTML("<h3>‚öôÔ∏è Optimization Settings</h3>"),
            self.opt_method_dropdown,
            self.max_geom_steps,
            self.force_tol
        ])
        
        scf_settings = widgets.VBox([
            widgets.HTML("<h3>üîÑ SCF Settings</h3>"),
            self.max_scf_cycles,
            self.scf_damping,
            self.level_shift
        ])
        
        advanced_settings = widgets.VBox([
            widgets.HTML("<h3>‚ö° Advanced Settings</h3>"),
            widgets.HBox([self.cpus_per_job, self.max_memory]),
            widgets.HBox([self.dispersion_dropdown, self.solvation_dropdown, self.solvent_dropdown])
        ])
        
        io_settings = widgets.VBox([
            widgets.HTML("<h3>üíæ I/O Settings</h3>"),
            self.output_dir,
            widgets.HBox([self.save_wavefunction, self.save_cube_files])
        ])
        
        tabs = widgets.Tab()
        tabs.children = [basic_settings, optimization_settings, scf_settings, advanced_settings, io_settings]
        tabs.titles = ['Basic', 'Optimization', 'SCF', 'Advanced', 'I/O']
        
        # Control buttons
        controls = widgets.HBox([
            self.optimize_button,
            self.stop_button,
            self.preview_button,
            self.reset_button
        ])
        
        # Status area
        status_area = widgets.VBox([
            widgets.HTML("<h3>üìä Status</h3>"),
            self.status_label,
            self.progress_bar
        ])
        
        # Information panels
        func_info = widgets.HTML("""
        <div style='background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 12px;'>
            <b>üß¨ Modular Functional Guide:</b><br>
            ‚Ä¢ <b>Hybrid</b> (B3LYP, PBE0): Best for organic molecules<br>
            ‚Ä¢ <b>GGA</b> (BLYP, PBE): Good balance of speed/accuracy<br>
            ‚Ä¢ <b>Meta-GGA</b> (TPSS, M06L): Better for transition metals<br>
            ‚Ä¢ <b>Range-Separated</b> (CAM-B3LYP, œâB97X): Better for charge transfer
        </div>
        """)
        
        advanced_options = widgets.HTML("""
        <div style='background: #e8f4f8; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 12px;'>
            <b>üîß Advanced Modular Options:</b><br>
            ‚Ä¢ <b>Dispersion (D3/D4):</b> Essential for weak interactions (stacking, H-bonding)<br>
            ‚Ä¢ <b>Solvation (PCM/COSMO):</b> Implicit solvent for realistic drug environments<br>
            ‚Ä¢ <b>ECP:</b> Effective core potentials for heavy elements (reduces computation)<br>
            ‚Ä¢ <b>SCF Damping/Level Shift:</b> Help with difficult SCF convergence<br>
            ‚Ä¢ <b>Modular Design:</b> All components can be easily customized and extended
        </div>
        """)
        
        # Complete interface
        interface = widgets.VBox([
            header,
            tabs,
            controls,
            status_area,
            func_info,
            advanced_options,
            self.output
        ])
        
        return interface